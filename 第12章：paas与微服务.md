## 什么是微服务

**微服务** \(Micro services\) 是一种软件架构风格 \(Software Architecture Style\)，它是以专注于单一责任与功能的小型功能区块 \(Small Building Blocks\) 为基础，利用模组化的方式组合出复杂的大型应用程序，各功能区块使用与语言无关 \(Language-Independent\/Language agnostic\) 的 API 集相互通讯。

微服务是以业务功能为主进行设计，每一个微服务都具有自主运行的业务功能，对外开放不受语言限制的 API \(最常用的是 HTTP协议的Rest API\)，应用程序则是由一个或多个微服务组成。相对于微服务的是**单体式 \(Monolithic\)** 应用程序，单体式应用表示一个应用程序内包含了所有需要的业务功能。

## **微服务架构的益处**

首先，通过分解巨大**单体式 \(Monolithic\)** 应用为多个服务的方法解决了复杂性问题。“大事划小”这是我们处理复杂事物的一贯原则，只要能不断的切分，任何复杂事物最后会变成简单的“分子”、“原子”的各种叠加。分解后的每个可管理的微服务都有一个清晰定义的边界，通过RPC或者消息API的方式对外服务。微服务架构使得复杂的单体式应用变成模块化，从而降低了开发和维护的难度。

其次，拆解后的微服务可以由多个技能不同的团队来实施开发。这些不同的技能既包括使用的语言、编译环境，也可以是不同的框架和数据库等。因此微服务的方式给了开发者更多的自由选择，不同要求的服务可以用更加适合的技术来实现。对于长期的项目也可以随着发展逐步抛弃过时的技术，即使用现在技术重写以前代码也不是很困难的事情。

再次，微服务架构模式是每个微服务独立的部署。开发者不再需要协调其它服务部署对本服务的影响。这种改变可以加快部署速度。UI团队可以采用AB测试，快速的部署变化。微服务架构模式使得持续化部署成为可能。

最后，微服务架构模式使得每个服务独立扩展。你可以根据每个服务的规模来部署满足需求的规模。甚至于，你可以使用更适合于服务资源需求的硬件。比如，你可以在EC2 Compute Optimized instances上部署CPU敏感的服务，而在EC2 memory-optimized instances上部署内存数据库。根据业务复杂度和用户访问规模的变化，不同的微服务可以有不同的伸缩策略来满足流量高峰。

## **微服务架构的不足**

“没有银弹”，微服务架构也不例外，我们需要根据应用场景、团队技能等来选择合适的架构。

其中一个不足在于难以选择合适的微服务粒度，这是从SOA（面向服务架构）遗留来的微服务的不足。有一些人主张按照代码行来分割服务，但这种机械的方式并不适合。仍然需要按照业务来进行服务的拆分，目的还是让每个服务之间耦合程度低，服务内部高度聚合。从实际上来说，一定需要避免在数据层面大量耦合，否则不可避免要实现跨服务的事务，进行两阶段提交。只有做到了这点才能实现敏捷开发和部署。

另外一个不足是分布式系统的复杂性。因此微服务默认允许各个服务部署在不通的节点，通过RPC（远程过程调用）来实现互相的访问，这相比IPC（进程内调用）的方式更加复杂。不但需要解决消息的可靠性问题，还需要实现异常处理的逻辑来保持事务完整性。在遇到性能瓶颈的时候，还必须很好地处理代码避免大量重发的请求引起“雪崩”效应。短路保护和降级是因对这种高并发、大吞吐场景中必备的安全措施。

另外一个关于微服务的挑战来自于跨数据库的事务保障。一个完整的业务流程中可能需要多个数据结构提交事务更新，这对于单体式应用来说很容易，因为只有一个数据库，而大部分的关系数据库的事物完整性机制非常健全。但在微服务架构应用中，由于每个应用有自己的独立数据库，而数据之间的事务完整性维持非常麻烦，通常要通过两阶段提交才能基本保障，因此如果微服务的划分不恰当的话反而会给数据库的更新带来一系列的困难。另外一些新的后端支持服务，例如高扩展性的NoSQL数据库和消息传递中间件并不支持事务，这也给其他数据库的事务完整性造成了影响。可能最终我们不得不使用最终一致性，通过消息总线来进行事务的传播，这给开发者提出了更高的要求和挑战。

微服务架构下集成测试可能也更麻烦。因为一个微服务可能需要调用其他微服务才能完成一个业务，所以在集成测试环节中，必须保证所需的服务正确响应需求。也许我们会通过一些stubs（假装其他微服务的桩子）来实现。也有一些方法来指导开发者进行一种基于合约的测试。

部署和监控微服务也比较复杂。通常一个完整的应用系统拥有数十个到数百个微服务，比如Hailo有160个不同服务构成，NetFlix有大约600个服务。而且每个微服务都有多个实例，这些实例随着负载的变化而变化。每一个微服务实例都需要被配置、部署、自动扩展和受到监控。而且一旦微服务进行扩容和收缩实例后，供外接调用它的服务发现机制还需要同步更新。这一切相比原来部署一套单体服务架构来说复杂了不少，如果缺少一个合适的平台和工具，这将成为运维人员的灾难，从而加大了以前一章所描述的DevOps的困难。PaaS云平台正好能解决这个问题，因此它将微服务的开发和上线过程通过持续集成和持续交付的工具进行了自动化，并搭建好了一个Dev和Ops完美分工的界面。

## 微服务架构的实现方式

```
插入：微服务架构的实现方式
```



## 微服务架构与PaaS

微服务架构带来了开发效率和运行效率的提升，但如果缺少适当的工具就会有很高的运维成本，Docker改变了这一切。开发者可以不用使用Spring Cloud或Dubbo这样的Java语言级框架；并且Docker接管了资源控制、安全隔离、网络可达、日志、运行监控、健康检查等复杂、琐碎且重复的事宜。Docker降低了我们应用微服务的难度，使得架构师可以将功能拆小，小意味着简单、可扩展性强、可靠性高、可以自由组合。

如果只是几台机器的小规模部署系统，仅用Docker在传统工具下自动部署就可以，但是一个大型的、多租户的系统，还是需要一个完善的容器编排框架，并将所有容器难以承担的有状态后端服务进行管理，那就是PaaS。PaaS使得微服务的部署不用关心物理集群、可以跨集群进行访问、微服务可以形成组合并有效隔离、集中收集日志、维持全局微服务状态，PaaS还提供了服务注册和发现的框架，使得应用不需要自己实现。当然PaaS还集中管理了持久化卷以及诸如Mysql之类的Backing Service，使得微服务的开发和运维工作进一步简化。

所以说PaaS云平台的形式使得更多的开发者可以负担得起微服务的架构。

