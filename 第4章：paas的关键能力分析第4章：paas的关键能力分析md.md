PaaS管理平台给开发者提供了托管其代码的环境，并将各种监控和运维的手段也提供出来，让开发者可以实现DevOps。因此完善的PaaS管理平台必须具备一些关键能力。本章将从功能的层面分析PaaS管理平台需要具备的关键能力，以便第二部分介绍各种PaaS平台管理软件的时候进行准确地术语描述和实现对比。

在介绍PaaS关键能力之前，需要重点介绍一下“状态”的含义，这在PaaS中，特别是在通过Docker实现的PaaS中非常关键。“状态”特指程序中需要维护的上下文信息，它通常由程序存储并会被后续的程序使用。

在之前的开发模式中，开发者通常喜欢将程序运行的状态保存在程序自身的数据结构中，这些状态包括HTTP的session、程序暂存的数据、程序的日志等。如果一个程序是这样实现的，我们将其称之为有状态的程序（stateful），这样的程序高可用和可扩展这两项非功能需求只能由开发者自己实现，因为PaaS平台并不掌握其“状态”重建或者分裂的逻辑。

但如果一个程序在设计中就将“状态”保存在程序之外，比如通过外部的缓存、数据库或者消息总线来保存，那么这样的程序被称为无状态的程序（statless），这样的程序对于PaaS来说是非常完美的，因为可以将其高可用和可扩展完全交给PaaS平台来实现。PaaS平台负责维护其“期望状态”和“实际状态”的一致性，极大体现了PaaS管理平台给开发者提供的便利性。

围绕“状态”，Heroku提出了一系列在PaaS中软件设计的原则，被称为“**十二因子**”，具体在附录A展开介绍。而根据这些最佳实践，Google提出了云原生（Cloud Natvie）的概念，并成立了云原生协会CNCF。

PaaS管理平台的关键能力分为九个，如下图所示：

`插图：关键能力图`

`开发者界面：开发管理 可用性管理 编排`

`－－－－－－－－－－`

`核心：运行时环境 后端支持服务 服务发现和路由`

`－－－－－－－－－－`

`IaaS适配：IaaS资源管理和调度 持久化 租户管理`

接下来先从PaaS管理平台的核心部分开始介绍，然后介绍面向应用开发者的界面，最后介绍与底层IaaS的对接和管理。

## 运行时环境

PaaS最重要的责任就是托管开发者提交的代码，而这些代码运行的环境就是“运行时环境”（runtime）。运行时环境不仅需要提供语言的编译和运行的支持，还需要提供相应的基础库文件。不同开发者、不同项目的运行时环境还需要隔离开来，形成沙盒的机制，一个环境出现问题不应该影响其他的环境。

一个成功的PaaS的运行时环境会做得尽量与开发者本地开发测试环境一致。但这在Docker之前很难实现，最早GAE通过语言级的沙盒提供了PHP、Python等语言的阉割版运行时环境给开发者，导致开发者比较难以开发和调试；Heroku通过Buildpack自动识别用户使用的语言，从而选择正确的运行时环境，降低了使用难度；Cloud Foundry参考了这一实现，并通过自己的容器格式Warden运行在自己特定的运行时环境Droplet中，进一步提高了易用性。

但直到Docker出现，开发者才拥有了一个理想的运行时环境，它可以完全实现开发、测试和生产环境的一致性，并能方便地进行调试，不限制任何语言和库环境。

## 后端支持服务

按照最佳实践，在运行时环境中运行的用户代码最好是无状态的（statless）。这样这些代码的高可用和可扩展就可以完全由PaaS平台本身来管理，降低开发者需要做出的努力。但除非是非常简单的Web类应用可以完全没有状态，比如1024之类的游戏，其他应用都会或多或少需要“状态”的维持来提升客户体验，那么这些状态又放在哪儿保存呢？十二因子给了我们一个答案，通过Backing Service来实现这些状态的托管。我们将其译作**后端支持服务**。

数据库、缓存和消息总线等可以持久化状态的服务可以通过PaaS平台提供，GAE、Heroku和Cloud Foundry都提供基础的后端支持服务。开发者可以轻松地申请后端支持服务的实例，并在自己的应用代码中使用它们，将应用代码需要记住的状态保存在这些后端支持服务中。

后端支持服务的实例由云平台负责维护数据的可靠性和性能，云平台保证其申请时承诺的服务水平SLA得到满足。

通过这样的方式，我们就像盘古开天地一样，将轻而清的东西（无状态应用）形成“天”（托管在运行时环境中），而将重而浊的东西（保存状态的后端支持服务实例）形成“地”（由云平台负责管理）。这些保存状态的后端服务实例通常比较难以管理和保证服务水平，因此通过云平台来管理进一步降低了开发者需要付出的努力。

**支持一系列开发者急需的良好质量保证的后端支持服务是一个成功PaaS云平台的必要条件**。

## 服务发现与路由

除非是简单的Web应用，否则托管在PaaS云平台中的用户代码很少能独立实现一个应用。通常要数个代码一起相互配合才可以。微服务架构的兴起使得解耦架构成为了主流，也使得一个应用被拆分成更多直接运行起来的组件。而PaaS平台的存在其实“助长”了这样的风气，因为PaaS带给开发者的便利，使得他可以负担起多个运行组件的拆分。

在这样的情况下，提供合适的用户的不同代码之间互相访问的机制就变得非常重要。通过IP转发或DNS进行服务发现是比较通常的做法，DNS的服务发现机制简单但面对代码运行情况的变化可能有一些延时；IP转发的方式能及时获知代码的运行情况并进行更新，但转发会降低性能。

内部不同代码之间的服务发现还需要考虑租户隔离的问题。因为应用程序内部访问通常不会设置较高的认证门槛和校验机制，所以如果内部服务发现被暴露到外部，被黑客获知可能就是一个安全漏洞。

为了不限制开发者的编程方式，内部服务发现会尽量选择更加底层的网络协议栈，一般就是四层TCP转发的模式。这样无论是HTTP或者其他上层协议均可以进行处理。

另外，为了让云平台的用户代码可以提供给外部访问，云平台还需要提供路由功能。路由功能与内部服务发现一个管理外部的访问路由一个管理内部的访问路由。

为了保证云平台的安全性以及监控应用的可用性，云平台的路由功能通常只支持七层的协议，比如HTTP和HTTPS。有一些云平台还提供会话粘连（Session Stick）的能力，这样对Web应用比较好。但最好不用这样的功能，因为其破坏了无状态的原则。

## 开发管理

除了上述三项PaaS的核心能力外，为了提高易用性，给开发者更多的支持，通常PaaS平台还会提供一些服务开发者的功能。我们统称为开发管理。通常包括如下：

* 代码库。云平台上提供一个代码库，不但可以解决跨团队协作的问题，而且让后续的持续集成可以方便地找到所需要的代码。
* 制品库。除了Python和PHP等解释型语言，其他语言都需要经过一定形式的预编译或编译。比如Java需要编译成机器代码并加入其他代码包，Go语言需要编译成静态的机器代码等。或者这些代码需要和其运行环境已经形成容器镜像等待运行。这些从代码生成的待运行的东西叫做制品（aitfisres），等待运行时环境载入。对于Docker而言，其制品库就是镜像仓库。
* 应用市场。PaaS平台中除了托管应用开发者开发的个性化应用之外，还需要能运行和定制化其他开发者开发的应用，这些应用就在应用市场中共其他人选用。它们或者是以代码的形式在其中运行，或者是一些开发的API。应用市场有助于扩展PaaS云服务提供商自身的生态，不但能引入除了其自身提供的后端支持服务的其他外部组件，还可以帮助云平台中的开发者获取自己的收入。
* 构建过程管理。从代码到制品的构建过程，也是需要PaaS云平台提供的。这通常包括了定时或者按照代码提交事件进行的自动化构建和持续集成，帮助提高开发者的工作效率。
* 部署过程管理。同样，从制品库取到制品然后投入运行时环境的过程，也是需要PaaS云平台提供的。根据任务的不一样，需要支持几种形式的部署：常规的部署；一次性任务；每个节点都运行的服务。

## 可用性管理

开发者将代码托管给PaaS云平台，并通过部署过程指定了自己的运行期望之后，如果这些代码是符合无状态的标准，那么应该就可以由PaaS云平台来负责其运行状态。我们将其定义为可用性管理。

通常PaaS平台会维护期望状态和实际状态的一致性，也就是说如果运行时环境出现非预期的问题，比如当机，那么云平台会选择另外的节点继续运行此段代码，并通过技术机制使得最终用户和开发者都没有感知。

除此之外，为了提供更多的便利性，PaaS平台还可以在现有可用性管理的基础上提供弹性伸缩的功能，以应对预期范围内的流量高峰，例如双十一之类的活动。还可以通过预设策略来让平台自己管理伸缩的动作，我们称之为自动伸缩。

同样的功能还可以用在滚动升级、灰度发布和蓝绿发布之中。

实现可用性管理，通常需要健康检查、设定预期和维持预期-实际一致三种子功能。

## 编排

如前文所诉，复杂的应用环境中通常需要多个运行时环境中的代码以及多个后端服务实例一起合作才能实现一个完整的应用。如果每一次部署都需要手工来指定其中的关联关系未免太过低效。在这种场景下编排就可以发挥作用来降低开发者的难度。

在这里，我们按照微服务的最佳实践，也遵照十二因子的原则，将运行时环境中运行起来的制品叫做“服务”，而将一系列的“服务”和若干个后端服务实例称之为“应用”。“应用”在拥有编排的PaaS中是一个很重要的概念，不同的平台对此有不同的称谓，比如在Docker Swarm和Rancher中成为Stack，而Marathon中被称为Application。

因此在本书中：应用=n个服务+m和后端支持服务实例，其中前者多为无状态的。

```
插图
```

编排的作用就是利用代码中的编排文件，由PaaS云平台自动生成上述应用。它不但要指定运行时环境，还需要选择后端支持服务，定义服务发现和路由，定义高可用状态。

最理想的是通过一个命令就可以使得一切完美的运行起来，同时运行人家在应用市场中的应用也如此这般的简单。

## IaaS资源管理和调度

上述三节介绍了PaaS云平台在三个核心功能的基础上为了降低开发者的使用难度而提供的三个北向接口能力，接下来介绍面向IaaS的南向接口。

由于PaaS中托管的服务、后端服务实例、甚至PaaS平台本身都运行在IaaS平台上，另外PaaS云平台需要适配诸多私有环境。因此一个成功的PaaS云平台必须要具备一个合适的IaaS适配层。通过这个适配层屏蔽不同的IaaS的差别，这样就既可以部署在AWS、Azure等公有云之上，也可以部署在openstack和vsphere的私有环境中。

其次，PaaS云平台需要提供调度的功能，使得应用的负荷均匀或者按照可靠性的规则运行在不同的节点之上。

最后，PaaS云平台面向平台管理者也需要有足够的工具来进行自身功能组件的部署和监控，以及IaaS资源的监控。

## 持久化存储

虽然说托管在运行时环境中的代码最好是无状态的，满足十二因子的，但是这意味着开发者需要对原有代码进行改动或者在开发新代码的时候采用新的机制，后者有一定的学习成本。为了尽可能兼容遗留的“有状态”的代码，PaaS云平台仍应给开发者提供持久化存储的手段，以便其代码将“状态”持久化到磁盘上。在这种情况下，用户不得不自己处理高可用和可扩展的问题，但降低了从传统方式向PaaS云平台上迁移的难度。

鉴于底层使用IaaS的情况，这些持久化存储多是通过网络的方式进行挂载的，比如ceph和glusterfs就是比较通用的两种机制。PaaS平台一般会通过插件或者扩展的方式来屏蔽不同持久化存储手段的差异，给开发者提供一个一致的Posix风格文件系统。

## 租户管理

PaaS云平台提供给了开发者一个虚拟化的，可以编译和运行他们代码的一个环境。但这些代码其实是使用的一套IaaS环境，因此PaaS云平台必须要提供足够的租户管理手段来实现有效的虚拟化。相比IaaS和SaaS，PaaS的租户管理更难。因为PaaS云平台是服务于应用开发者的，他们是这个世界上最挑剔的人，不但需要掌握足够的自由权利，也需要云平台提供足够的便利。

PaaS云平台需要有足够的安全防护策略，防止租户之间互相侵犯。在资源层面上，也需要做好隔离，要能保证给租户承诺的SLA。同样需要提供足够的监控和日志给租户，让他们知道自己的虚拟化环境中发生了什么事情。

在早期的PaaS平台，比如GAE中，通过语言级的沙盒来实现，有诸多的不足和不便利。后来一些PaaS平台演变出了自己的容器环境来进行租户管理，比如CloudFoundry的warden。Docker出现后，它被作为一种主要的租户隔离手段存在，较好的实现了租户管理所需的功能。

